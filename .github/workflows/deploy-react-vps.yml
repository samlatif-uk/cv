name: Deploy sites to VPS

on:
  push:
    branches: [main]
    paths:
      - react.samlatif.uk/**
      - index.html
      - shared/cv-data.json
      - shared/filter-utils.js
      - shared/site.css
      - shared/ui-shared.css
      - favicon-96x96.png
      - favicon.ico
      - apple-touch-icon.png
      - favicon.svg
      - site.webmanifest
      - web-app-manifest-192x192.png
      - web-app-manifest-512x512.png
      - .github/workflows/deploy-react-vps.yml
  workflow_dispatch:

concurrency:
  group: deploy-sites-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: react.samlatif.uk/package-lock.json

      - name: Validate DNS record exists
        run: |
          DOMAIN="${{ secrets.REACT_DOMAIN }}"
          DOMAIN="${DOMAIN:-react.samlatif.uk}"

          RESOLVED_IP="$(dig +short A "$DOMAIN" | tail -n 1)"

          if [ -z "$RESOLVED_IP" ]; then
            echo "DNS check failed: $DOMAIN does not resolve to an A record yet."
            echo "Create DNS first, then re-run deploy."
            exit 1
          fi

          echo "DNS check passed: $DOMAIN -> $RESOLVED_IP"

      - name: Validate apex DNS record exists (optional)
        run: |
          APEX_DOMAIN="${{ secrets.APEX_DOMAIN }}"

          if [ -z "$APEX_DOMAIN" ]; then
            echo "Apex DNS check skipped: secret APEX_DOMAIN is not set."
            exit 0
          fi

          RESOLVED_IP="$(dig +short A "$APEX_DOMAIN" | tail -n 1)"

          if [ -z "$RESOLVED_IP" ]; then
            echo "DNS check failed: $APEX_DOMAIN does not resolve to an A record yet."
            echo "Create DNS first, then re-run deploy."
            exit 1
          fi

          echo "Apex DNS check passed: $APEX_DOMAIN -> $RESOLVED_IP"

      - name: Check local deploy privileges
        run: |
          if [ "$(id -u)" -eq 0 ]; then
            echo "Runner is root."
            exit 0
          fi

          if sudo -n true >/dev/null 2>&1; then
            echo "Runner has passwordless sudo."
            exit 0
          fi

          echo "Self-hosted runner user must be root or have passwordless sudo for deploy steps."
          exit 1

      - name: Install dependencies
        working-directory: react.samlatif.uk
        run: npm ci

      - name: Build
        working-directory: react.samlatif.uk
        run: npm run build

      - name: Ensure deploy directories exist
        run: |
          DEPLOY_PATH="${{ secrets.VPS_DEPLOY_PATH }}"
          DEPLOY_PATH="${DEPLOY_PATH:-/var/www/react.samlatif.uk}"
          STATIC_DEPLOY_PATH="${{ secrets.STATIC_DEPLOY_PATH }}"
          STATIC_DEPLOY_PATH="${STATIC_DEPLOY_PATH:-/var/www/samlatif.uk}"

          if [ "$(id -u)" -eq 0 ]; then SUDO=""; else SUDO="sudo"; fi

          $SUDO mkdir -p "$DEPLOY_PATH" "$STATIC_DEPLOY_PATH" "$STATIC_DEPLOY_PATH/shared"

      - name: Install React nginx vhost config
        run: |
          if [ "$(id -u)" -eq 0 ]; then SUDO=""; else SUDO="sudo"; fi

          $SUDO install -m 644 scripts/react.nginx.conf /etc/nginx/sites-available/react.samlatif.uk
          $SUDO ln -sfn /etc/nginx/sites-available/react.samlatif.uk /etc/nginx/sites-enabled/react.samlatif.uk
          $SUDO nginx -t
          $SUDO systemctl reload nginx

      - name: Sync built files locally
        run: |
          DEPLOY_PATH="${{ secrets.VPS_DEPLOY_PATH }}"
          DEPLOY_PATH="${DEPLOY_PATH:-/var/www/react.samlatif.uk}"

          if [ "$(id -u)" -eq 0 ]; then SUDO=""; else SUDO="sudo"; fi

          $SUDO rsync -az --delete react.samlatif.uk/dist/ "$DEPLOY_PATH/"
          $SUDO rsync -az shared/filter-utils.js shared/site.css shared/ui-shared.css "$DEPLOY_PATH/"

      - name: Sync static site files locally
        run: |
          STATIC_DEPLOY_PATH="${{ secrets.STATIC_DEPLOY_PATH }}"
          STATIC_DEPLOY_PATH="${STATIC_DEPLOY_PATH:-/var/www/samlatif.uk}"

          if [ "$(id -u)" -eq 0 ]; then SUDO=""; else SUDO="sudo"; fi

          $SUDO rsync -az \
            index.html favicon-96x96.png favicon.ico apple-touch-icon.png favicon.svg site.webmanifest web-app-manifest-192x192.png web-app-manifest-512x512.png \
            "$STATIC_DEPLOY_PATH/"

          $SUDO rsync -az shared/cv-data.json "$STATIC_DEPLOY_PATH/shared/"
          $SUDO rsync -az shared/filter-utils.js shared/site.css shared/ui-shared.css "$STATIC_DEPLOY_PATH/shared/"

      - name: Set ownership and reload nginx/certbot
        run: |
          DEPLOY_PATH="${{ secrets.VPS_DEPLOY_PATH }}"
          DEPLOY_PATH="${DEPLOY_PATH:-/var/www/react.samlatif.uk}"
          STATIC_DEPLOY_PATH="${{ secrets.STATIC_DEPLOY_PATH }}"
          STATIC_DEPLOY_PATH="${STATIC_DEPLOY_PATH:-/var/www/samlatif.uk}"
          DOMAIN="${{ secrets.REACT_DOMAIN }}"
          DOMAIN="${DOMAIN:-react.samlatif.uk}"
          APEX_DOMAIN="${{ secrets.APEX_DOMAIN }}"

          if [ "$(id -u)" -eq 0 ]; then SUDO=""; else SUDO="sudo"; fi

          $SUDO chown -R www-data:www-data "$DEPLOY_PATH" "$STATIC_DEPLOY_PATH"
          $SUDO nginx -t
          $SUDO systemctl reload nginx

          if command -v certbot >/dev/null 2>&1; then
            $SUDO certbot --nginx -d "$DOMAIN" --non-interactive --agree-tos -m hello@samlatif.uk --redirect || true
            if [ -n "$APEX_DOMAIN" ]; then
              $SUDO certbot --nginx -d "$APEX_DOMAIN" --non-interactive --agree-tos -m hello@samlatif.uk --redirect || true
            fi
          fi
