name: Deploy network app to VPS

on:
  push:
    branches: [main]
    paths:
      - network.samlatif.uk/**
      - shared/cv-data.json
      - .github/workflows/deploy-network-vps.yml
  workflow_dispatch:

concurrency:
  group: deploy-network-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: network.samlatif.uk/package-lock.json

      - name: Install dependencies
        working-directory: network.samlatif.uk
        run: npm ci

      - name: Build
        working-directory: network.samlatif.uk
        run: npm run build

      - name: Validate required secrets
        run: |
          if [ -z "${{ secrets.VPS_SSH_KEY }}" ]; then
            echo "Missing required secret: VPS_SSH_KEY"
            exit 1
          fi

      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Add VPS to known hosts
        run: |
          HOST="${{ secrets.VPS_HOST }}"
          HOST="${HOST:-79.99.45.146}"
          PORT="${{ secrets.VPS_PORT }}"
          PORT="${PORT:-22}"
          mkdir -p ~/.ssh
          ssh-keyscan -p "$PORT" -H "$HOST" >> ~/.ssh/known_hosts

      - name: Ensure deploy directories exist
        run: |
          HOST="${{ secrets.VPS_HOST }}"
          HOST="${HOST:-79.99.45.146}"
          USER="${{ secrets.VPS_USER }}"
          USER="${USER:-root}"
          PORT="${{ secrets.VPS_PORT }}"
          PORT="${PORT:-22}"

          APP_PATH="${{ secrets.NETWORK_VPS_APP_PATH }}"
          APP_PATH="${APP_PATH:-/var/www/network.samlatif.uk/app}"
          SHARED_PATH="${{ secrets.NETWORK_VPS_SHARED_PATH }}"
          SHARED_PATH="${SHARED_PATH:-/var/www/network.samlatif.uk/shared}"
          DATA_PATH="${{ secrets.NETWORK_VPS_DATA_PATH }}"
          DATA_PATH="${DATA_PATH:-/var/www/network.samlatif.uk/data}"

          ssh -p "$PORT" "$USER@$HOST" "mkdir -p '$APP_PATH' '$SHARED_PATH' '$DATA_PATH'"

      - name: Sync app files
        run: |
          HOST="${{ secrets.VPS_HOST }}"
          HOST="${HOST:-79.99.45.146}"
          USER="${{ secrets.VPS_USER }}"
          USER="${USER:-root}"
          PORT="${{ secrets.VPS_PORT }}"
          PORT="${PORT:-22}"

          APP_PATH="${{ secrets.NETWORK_VPS_APP_PATH }}"
          APP_PATH="${APP_PATH:-/var/www/network.samlatif.uk/app}"
          SHARED_PATH="${{ secrets.NETWORK_VPS_SHARED_PATH }}"
          SHARED_PATH="${SHARED_PATH:-/var/www/network.samlatif.uk/shared}"

          rsync -az --delete \
            --exclude='node_modules' \
            --exclude='.next' \
            --exclude='dev.db' \
            --exclude='prisma/dev.db' \
            -e "ssh -p $PORT" \
            "network.samlatif.uk/" \
            "$USER@$HOST:$APP_PATH/"

          rsync -az \
            -e "ssh -p $PORT" \
            "shared/cv-data.json" \
            "$USER@$HOST:$SHARED_PATH/"

      - name: Install, migrate, restart service, and reload nginx
        run: |
          HOST="${{ secrets.VPS_HOST }}"
          HOST="${HOST:-79.99.45.146}"
          USER="${{ secrets.VPS_USER }}"
          USER="${USER:-root}"
          PORT="${{ secrets.VPS_PORT }}"
          PORT="${PORT:-22}"

          APP_PATH="${{ secrets.NETWORK_VPS_APP_PATH }}"
          APP_PATH="${APP_PATH:-/var/www/network.samlatif.uk/app}"
          DATA_PATH="${{ secrets.NETWORK_VPS_DATA_PATH }}"
          DATA_PATH="${DATA_PATH:-/var/www/network.samlatif.uk/data}"
          DOMAIN="${{ secrets.NETWORK_DOMAIN }}"
          DOMAIN="${DOMAIN:-network.samlatif.uk}"
          APP_PORT="${{ secrets.NETWORK_PORT }}"
          APP_PORT="${APP_PORT:-3100}"
          SERVICE_NAME="${{ secrets.NETWORK_SERVICE_NAME }}"
          SERVICE_NAME="${SERVICE_NAME:-network-samlatif-uk}"

          ssh -p "$PORT" "$USER@$HOST" "
            set -e
            cd '$APP_PATH'
            npm ci

            export DATABASE_URL='file:$DATA_PATH/dev.db'
            npx prisma migrate deploy
            npm run build

            if ! command -v pm2 >/dev/null 2>&1; then
              npm install -g pm2
            fi

            export NODE_ENV='production'
            export PORT='$APP_PORT'

            if pm2 describe '$SERVICE_NAME' >/dev/null 2>&1; then
              pm2 restart '$SERVICE_NAME' --update-env
            else
              pm2 start npm --name '$SERVICE_NAME' -- start -- --port '$APP_PORT'
            fi
            pm2 save

            cat > /etc/nginx/sites-available/$DOMAIN <<'NGINXCONF'
            server {
              listen 80;
              server_name $DOMAIN;

              location / {
                proxy_pass http://127.0.0.1:$APP_PORT;
                proxy_http_version 1.1;
                proxy_set_header Host \$host;
                proxy_set_header X-Real-IP \$remote_addr;
                proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto \$scheme;
                proxy_set_header Upgrade \$http_upgrade;
                proxy_set_header Connection \"upgrade\";
              }
            }
NGINXCONF

            ln -sfn /etc/nginx/sites-available/$DOMAIN /etc/nginx/sites-enabled/$DOMAIN
            nginx -t
            systemctl reload nginx

            if command -v certbot >/dev/null 2>&1; then
              certbot --nginx -d $DOMAIN --non-interactive --agree-tos -m hello@samlatif.uk --redirect || true
            fi
          "
