name: Deploy network app to VPS

on:
  push:
    branches: [main]
    paths:
      - network.samlatif.uk/**
      - shared/cv-data.json
      - .github/workflows/deploy-network-vps.yml
  workflow_dispatch:

concurrency:
  group: deploy-network-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: self-hosted
    env:
      DATABASE_URL: file:./prisma/dev.db
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: network.samlatif.uk/package-lock.json

      - name: Validate DNS record exists
        run: |
          DOMAIN="${{ secrets.NETWORK_DOMAIN }}"
          DOMAIN="${DOMAIN:-network.samlatif.uk}"

          RESOLVED_IP="$(dig +short A "$DOMAIN" | tail -n 1)"

          if [ -z "$RESOLVED_IP" ]; then
            echo "DNS check failed: $DOMAIN does not resolve to an A record yet."
            echo "Create DNS first, then re-run deploy."
            exit 1
          fi

          echo "DNS check passed: $DOMAIN -> $RESOLVED_IP"

      - name: Check local deploy privileges
        run: |
          if [ "$(id -u)" -eq 0 ]; then
            echo "Runner is root."
            exit 0
          fi

          if sudo -n true >/dev/null 2>&1; then
            echo "Runner has passwordless sudo."
            exit 0
          fi

          echo "Self-hosted runner user must be root or have passwordless sudo for deploy steps."
          exit 1

      - name: Install dependencies
        working-directory: network.samlatif.uk
        run: npm ci

      - name: Prepare CI database
        working-directory: network.samlatif.uk
        run: npx prisma migrate deploy

      - name: Build
        working-directory: network.samlatif.uk
        run: npm run build

      - name: Prune to production dependencies
        working-directory: network.samlatif.uk
        run: npm prune --omit=dev

      - name: Ensure deploy directories exist
        run: |
          APP_PATH="${{ secrets.NETWORK_VPS_APP_PATH }}"
          APP_PATH="${APP_PATH:-/var/www/network.samlatif.uk/app}"
          SHARED_PATH="${{ secrets.NETWORK_VPS_SHARED_PATH }}"
          SHARED_PATH="${SHARED_PATH:-/var/www/network.samlatif.uk/shared}"
          DATA_PATH="${{ secrets.NETWORK_VPS_DATA_PATH }}"
          DATA_PATH="${DATA_PATH:-/var/www/network.samlatif.uk/data}"

          if [ "$(id -u)" -eq 0 ]; then SUDO=""; else SUDO="sudo"; fi

          $SUDO mkdir -p "$APP_PATH" "$SHARED_PATH" "$DATA_PATH"

      - name: Sync app files locally
        run: |
          APP_PATH="${{ secrets.NETWORK_VPS_APP_PATH }}"
          APP_PATH="${APP_PATH:-/var/www/network.samlatif.uk/app}"
          SHARED_PATH="${{ secrets.NETWORK_VPS_SHARED_PATH }}"
          SHARED_PATH="${SHARED_PATH:-/var/www/network.samlatif.uk/shared}"

          if [ "$(id -u)" -eq 0 ]; then SUDO=""; else SUDO="sudo"; fi

          $SUDO rsync -az --delete \
            --exclude='node_modules' \
            --exclude='dev.db' \
            --exclude='prisma/dev.db' \
            "network.samlatif.uk/" \
            "$APP_PATH/"

          $SUDO rsync -az --delete \
            "network.samlatif.uk/node_modules/" \
            "$APP_PATH/node_modules/"

          $SUDO rsync -az \
            "shared/cv-data.json" \
            "$SHARED_PATH/"

      - name: Migrate, restart service, and reload nginx
        run: |
          APP_PATH="${{ secrets.NETWORK_VPS_APP_PATH }}"
          APP_PATH="${APP_PATH:-/var/www/network.samlatif.uk/app}"
          DATA_PATH="${{ secrets.NETWORK_VPS_DATA_PATH }}"
          DATA_PATH="${DATA_PATH:-/var/www/network.samlatif.uk/data}"
          DOMAIN="${{ secrets.NETWORK_DOMAIN }}"
          DOMAIN="${DOMAIN:-network.samlatif.uk}"
          APP_PORT="${{ secrets.NETWORK_PORT }}"
          APP_PORT="${APP_PORT:-3100}"
          SERVICE_NAME="${{ secrets.NETWORK_SERVICE_NAME }}"
          SERVICE_NAME="${SERVICE_NAME:-network-samlatif-uk}"

          if [ "$(id -u)" -eq 0 ]; then SUDO=""; else SUDO="sudo"; fi

          cd "$APP_PATH"

          export DATABASE_URL="file:$DATA_PATH/dev.db"
          ./node_modules/.bin/prisma migrate deploy

          $SUDO tee "/etc/systemd/system/$SERVICE_NAME.service" >/dev/null <<EOF
          [Unit]
          Description=$SERVICE_NAME Next.js app
          After=network.target

          [Service]
          Type=simple
          WorkingDirectory=$APP_PATH
          Environment=NODE_ENV=production
          Environment=PORT=$APP_PORT
          Environment=DATABASE_URL=file:$DATA_PATH/dev.db
          ExecStart=$APP_PATH/node_modules/.bin/next start --port $APP_PORT
          Restart=always
          RestartSec=5
          User=root

          [Install]
          WantedBy=multi-user.target
          EOF

          $SUDO systemctl daemon-reload
          $SUDO systemctl enable --now "$SERVICE_NAME"
          $SUDO systemctl restart "$SERVICE_NAME"

          $SUDO tee "/etc/nginx/sites-available/$DOMAIN" >/dev/null <<EOF
          server {
            listen 80;
            server_name $DOMAIN;

            location / {
              proxy_pass http://127.0.0.1:$APP_PORT;
              proxy_http_version 1.1;
              proxy_set_header Host \$host;
              proxy_set_header X-Real-IP \$remote_addr;
              proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto \$scheme;
              proxy_set_header Upgrade \$http_upgrade;
              proxy_set_header Connection "upgrade";
            }
          }
          EOF

          $SUDO ln -sfn "/etc/nginx/sites-available/$DOMAIN" "/etc/nginx/sites-enabled/$DOMAIN"
          $SUDO nginx -t
          $SUDO systemctl reload nginx

          if command -v certbot >/dev/null 2>&1; then
            $SUDO certbot --nginx -d "$DOMAIN" --non-interactive --agree-tos -m hello@samlatif.uk --redirect || true
          fi
